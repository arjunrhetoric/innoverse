<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= githubProfile.name || user.name %>'s GitHub Profile - INNOVERSE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* Reusing GitHub profile styling */
    body { 
      background: #121212; 
      color: #fff; 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      padding: 0;
    }
    .profile-header { 
      text-align: center; 
      padding: 50px 0; 
    }
    .profile-header img { 
      border-radius: 50%; 
      width: 150px; 
      border: 4px solid #2575fc; 
    }
    .profile-header h2 { 
      font-size: 2rem; 
      font-weight: 700; 
      margin-top: 1rem; 
    }
    .profile-header p { 
      font-size: 1.1rem; 
      margin: 0.5rem 0 1rem; 
    }
    .btn-primary { 
      background: #2575fc; 
      border: none; 
    }
    .btn-primary:hover { 
      background: #1e54ff; 
    }
    .info { 
      text-align: center; 
      margin-top: 2rem; 
    }
    .info p { 
      margin: 0.5rem 0; 
      font-size: 1rem; 
    }

    .rating-stars {
  font-size: 1.2rem;
  letter-spacing: 2px;
}

.inline-comment-box {
  border: 1px solid #30363d;
  background: #0d1117 !important;
}

.inline-comment-box textarea {
  background: #161b22;
  border: 1px solid #30363d;
  color: #c9d1d9;
}

.card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">INNOVERSE</a>
      <div class="ms-auto">
        <a class="nav-link" href="/">Back to Dashboard</a>
      </div>
    </div>
  </nav>

  <div class="container" style="margin-top: 80px;">
    <div class="profile-header">
      <img src="<%= githubProfile.avatar_url %>" alt="Avatar">
      <h2><%= githubProfile.name || user.name %></h2>
      <p><%= githubProfile.bio || "No bio available" %></p>
      <a href="<%= githubProfile.html_url %>" target="_blank" class="btn btn-primary">
        <i class="fab fa-github me-2"></i>View on GitHub
      </a>
    </div>

    <div class="container mt-4">
      <h2 class="text-center mb-4" style="font-weight: 700; background: linear-gradient(45deg, #2575fc, #6a11cb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ðŸŽ“ Certificates of Completion</h2>
      <% if (certificates.length === 0) { %>
          <div class="text-center py-5">
              <i class="fas fa-certificate fa-3x text-muted mb-3"></i>
              <p class="text-muted">No certificates earned yet</p>
          </div>
      <% } else { %>
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
              <% certificates.forEach(cert => { %>
                  <div class="col">
                      <div class="card h-100 border-0 shadow-lg hover-effect" 
                           style="background: rgba(255, 255, 255, 0.05); 
                                  backdrop-filter: blur(10px);
                                  border-radius: 15px;
                                  transition: transform 0.3s ease, box-shadow 0.3s ease;">
                        <div class="card-header bg-transparent border-bottom border-secondary">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <h5 class="mb-0 text-gradient">
                                      <%= cert.problemId?.title || "Unknown Project" %>
                                  </h5>
                                  <small class="text-muted">
                                      Issued by 
                                      <% if (cert.startupId?.githubUsername) { %>
                                          <a href="https://github.com/<%= cert.startupId.githubUsername %>" 
                                             target="_blank" 
                                             class="text-decoration-none text-info">
                                              @<%= cert.startupId.githubUsername %>
                                          </a>
                                      <% } else { %>
                                          <span class="text-warning">
                                              <%= cert.startupId?.name || "Anonymous Startup" %>
                                          </span>
                                      <% } %>
                                  </small>
                              </div>
                              <i class="fas fa-award fa-lg text-warning"></i>
                          </div>
                      </div>
                          
                          <!-- PDF Preview Thumbnail -->
                          <div class="position-relative" style="height: 200px; overflow: hidden;">
                              <canvas id="pdf-<%= cert._id %>" class="w-100 h-100"></canvas>
                              <div class="position-absolute top-0 start-0 bg-dark bg-opacity-50 w-100 h-100 d-flex align-items-center justify-content-center">
                                  <button class="btn btn-outline-light btn-sm" 
                                          data-bs-toggle="modal" 
                                          data-bs-target="#certificateModal<%= cert._id %>">
                                      <i class="fas fa-expand me-2"></i>View Full Certificate
                                  </button>
                              </div>
                          </div>
  
                          <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                  <div class="star-rating">
                                      <% for(let i=0; i<5; i++) { %>
                                          <i class="fas fa-star <%= i < cert.rating ? 'text-warning' : 'text-secondary' %>"></i>
                                      <% } %>
                                  </div>
                                  <span class="badge bg-primary rounded-pill">
                                      <%= new Date(cert.issuedAt).toLocaleDateString() %>
                                  </span>
                              </div>
                              <p class="card-text text-light mb-3"><%= cert.review %></p>
                          </div>
                          
                          <div class="card-footer bg-transparent border-top border-secondary">
                              <div class="d-flex justify-content-between align-items-center">
                                  <a href="<%= cert.certificateFile %>" 
                                     class="btn btn-sm btn-outline-light">
                                      <i class="fas fa-download me-2"></i>Download
                                  </a>
                                  <span class="text-muted small" data-bs-toggle="tooltip" 
                                        title="Verification Code">
                                      <i class="fas fa-fingerprint me-1"></i><%= cert.verificationCode %>
                                  </span>
                              </div>
                          </div>
                      </div>
                  </div>
  
                  <!-- Modal -->
                  <div class="modal fade" id="certificateModal<%= cert._id %>" tabindex="-1">
                      <div class="modal-dialog modal-xl modal-dialog-centered">
                          <div class="modal-content bg-dark">
                              <div class="modal-header border-secondary">
                                  <h5 class="modal-title text-gradient"><%= cert.problemId.title %></h5>
                                  <button type="button" class="btn-close btn-close-white" 
                                          data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                  <div class="row">
                                      <div class="col-md-8">
                                          <canvas id="modal-pdf-<%= cert._id %>" 
                                                  class="w-100 rounded-3"></canvas>
                                      </div>
                                      <div class="col-md-4">
                                          <div class="d-flex flex-column gap-3">
                                              <div>
                                                  <h6 class="text-muted mb-2">Details</h6>
                                                  <ul class="list-unstyled">
                                                      <li class="mb-2">
                                                          <i class="fas fa-building me-2"></i>
                                                          <%= cert.startupId.githubUsername %>
                                                      </li>
                                                      <li class="mb-2">
                                                          <i class="fas fa-calendar me-2"></i>
                                                          <%= new Date(cert.issuedAt).toLocaleDateString() %>
                                                      </li>
                                                      <li class="mb-2">
                                                          <i class="fas fa-fingerprint me-2"></i>
                                                          <%= cert.verificationCode %>
                                                      </li>
                                                  </ul>
                                              </div>
                                              <div>
                                                  <h6 class="text-muted mb-2">Review</h6>
                                                  <p class="text-light"><%= cert.review %></p>
                                              </div>
                                              <div>
                                                  <h6 class="text-muted mb-2">Rating</h6>
                                                  <div class="star-rating">
                                                      <% for(let i=0; i<5; i++) { %>
                                                          <i class="fas fa-star <%= i < cert.rating ? 'text-warning' : 'text-secondary' %>"></i>
                                                      <% } %>
                                                  </div>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              <% }) %>
          </div>
      <% } %>
  </div>
  
  <style>
      .text-gradient {
          background: linear-gradient(45deg, #2575fc, #6a11cb);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          font-weight: 600;
      }
  
      .hover-effect:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 25px rgba(37, 117, 252, 0.15);
      }
  
      .star-rating {
          font-size: 1.1rem;
      }
  
      .modal-content {
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 15px;
          backdrop-filter: blur(10px);
          background: rgba(30, 30, 30, 0.9) !important;
      }
  </style>
  
  <script>
      // Properly serialize EJS data to JavaScript
      const certificates = <%- JSON.stringify(certificates) %>;
  
      // Initialize PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';
  
      // Modified loadPDF function
      async function loadPDF(certId, url, isModal = false) {
          try {
              const loadingTask = pdfjsLib.getDocument(url);
              const pdf = await loadingTask.promise;
              const page = await pdf.getPage(1);
              
              const canvasId = isModal ? `modal-pdf-${certId}` : `pdf-${certId}`;
              const canvas = document.getElementById(canvasId);
              const viewport = page.getViewport({ scale: isModal ? 1.2 : 0.5 });
              
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              
              const renderContext = {
                  canvasContext: canvas.getContext('2d'),
                  viewport: viewport
              };
              
              await page.render(renderContext).promise;
          } catch (error) {
              console.error('Error loading PDF:', error);
          }
      }
  
      // Initialize all certificates after DOM loads
      document.addEventListener('DOMContentLoaded', () => {
          certificates.forEach(cert => {
              // Use the correct path from the serialized data
              const fullPath = `<%= process.env.BASE_URL %>${cert.certificateFile}`;
              loadPDF(cert._id, fullPath);
              loadPDF(cert._id, fullPath, true);
          });
      });
  </script>


    <div class="info">
      <p>Public Repositories: <%= githubProfile.public_repos %></p>
      <p>Followers: <%= githubProfile.followers %></p>
      <p>Following: <%= githubProfile.following %></p>
    </div>
  </div>  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
